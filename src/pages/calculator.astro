---
import Layout from "../layouts/Layout.astro";
import ConsultationCTA from "../components/ConsultationCTA.astro";
---

<Layout
  title="Retention Maturity Calculator | Kinga Dow"
  description="Score your e-commerce retention strategy. Discover if your email marketing is ready for $2M+ revenue with our free AI-powered assessment."
>
  <!-- ========================================
       HERO SECTION
       ======================================== -->
  <section class="hero-gradient relative overflow-hidden">
    <!-- Decorative circle pattern - left side -->
    <div class="absolute -left-20 top-16 w-[380px] h-[380px] opacity-30 pointer-events-none">
      <img src="/images/home/decorative/bg-circle-left.png" alt="" class="w-full h-full object-contain" aria-hidden="true" />
    </div>

    <div class="max-w-4xl mx-auto px-6 py-12 md:py-16 relative z-10">
      <div class="text-center">
        <!-- Label -->
        <span class="animate-on-scroll fade-in-up font-aktiv text-kd-gold font-medium text-[14px] leading-[17px] tracking-[1.4px] mb-4 block uppercase">
          Free Assessment
        </span>

        <!-- H1 -->
        <h1 class="animate-on-scroll fade-in-up delay-100 font-aktiv text-kd-navy text-[24px] md:text-[42px] font-bold leading-[36px] md:leading-[52px] tracking-[1.4px] md:tracking-[2.1px] mb-6">
          Retention Maturity Assessment
        </h1>

        <!-- Subtitle -->
        <p class="animate-on-scroll fade-in-up delay-200 font-montserrat font-light text-black text-[16px] md:text-[18px] mb-4 max-w-[700px] mx-auto leading-[26px] md:leading-[30px] tracking-[1.6px] md:tracking-[1.8px]">
          Is your retention strategy mature enough for $2M+ revenue?
        </p>

        <p class="animate-on-scroll fade-in-up delay-300 font-montserrat text-kd-grey text-[14px] md:text-[15px] leading-[22px] tracking-[1.4px]">
          Score each category â€¢ Total possible: 50 points
        </p>
      </div>
    </div>
  </section>

  <!-- ========================================
       SCORE DISPLAY SECTION
       ======================================== -->
  <section class="py-8 md:py-12 bg-white">
    <div class="max-w-4xl mx-auto px-6">
      <div class="animate-on-scroll fade-in-up bg-kd-cream rounded-[21px] p-6 md:p-8" style="box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
        <div class="flex items-center justify-between">
          <div>
            <p class="font-aktiv text-kd-grey font-medium text-[12px] md:text-[14px] uppercase tracking-[1.2px] mb-2">Your Current Score</p>
            <p class="font-aktiv text-kd-navy text-[40px] md:text-[56px] font-bold leading-none">
              <span id="current-score">0.0</span>
              <span class="text-[20px] md:text-[28px] text-kd-grey ml-2">/ 50</span>
            </p>
          </div>
          <div class="text-right">
            <div id="percentage-circle" class="w-20 h-20 md:w-24 md:h-24 rounded-full bg-kd-gold flex items-center justify-center text-white text-2xl md:text-3xl font-bold font-aktiv" style="box-shadow: 0 4px 15px rgba(186, 146, 0, 0.3);">
              <span id="percentage-value">0</span>%
            </div>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="mt-6">
          <div class="w-full bg-white rounded-full h-3 overflow-hidden">
            <div
              id="progress-bar"
              class="h-full bg-kd-gold transition-all duration-500 ease-out rounded-full"
              style="width: 0%"
            ></div>
          </div>
        </div>

        <!-- Completion indicator -->
        <p id="completion-status" class="mt-4 text-center font-montserrat text-kd-grey text-[14px] tracking-[1.4px]">
          Answer all 10 questions to see your results
        </p>
      </div>
    </div>
  </section>

  <!-- ========================================
       ASSESSMENT QUESTIONS SECTION
       ======================================== -->
  <section class="py-8 md:py-12 bg-white">
    <div class="max-w-4xl mx-auto px-6">
      <div id="questions-container" class="space-y-6">
        <!-- Questions will be rendered by JavaScript -->
      </div>
    </div>
  </section>

  <!-- ========================================
       RESULTS SECTION (Hidden until complete)
       ======================================== -->
  <section id="results-section" class="py-8 md:py-12 bg-white hidden">
    <div class="max-w-4xl mx-auto px-6">
      <!-- Results Card -->
      <div id="results-card" class="animate-on-scroll fade-in-up rounded-[21px] p-8 md:p-10 mb-8" style="box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);">
        <div class="flex items-center gap-4 md:gap-6 mb-6">
          <div id="results-icon" class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-white flex items-center justify-center" style="box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
            <!-- Icon inserted by JS -->
          </div>
          <div>
            <h2 id="results-level" class="font-aktiv text-[21px] md:text-[32px] font-bold leading-tight tracking-[1.2px] mb-2">
              <!-- Level inserted by JS -->
            </h2>
            <p id="results-message" class="font-montserrat text-[16px] md:text-[18px] leading-[26px] tracking-[1.6px]">
              <!-- Message inserted by JS -->
            </p>
          </div>
        </div>

        <!-- What this means -->
        <div class="bg-white rounded-[16px] p-6 mb-6">
          <h3 class="font-aktiv text-kd-navy text-[18px] md:text-[20px] font-semibold mb-4 tracking-[0.9px]">What this means:</h3>
          <ul id="results-details" class="space-y-3">
            <!-- Details inserted by JS -->
          </ul>
        </div>

        <!-- Next step -->
        <div class="bg-white rounded-[16px] p-6 mb-6">
          <h3 class="font-aktiv text-kd-navy text-[18px] md:text-[20px] font-semibold mb-4 tracking-[0.9px]">Your next step:</h3>
          <p id="results-nextstep" class="font-montserrat text-black text-[15px] md:text-[16px] leading-[26px] tracking-[1.5px] font-light">
            <!-- Next step inserted by JS -->
          </p>
        </div>

        <!-- Harsh Truth -->
        <div class="bg-kd-navy rounded-[16px] p-6 text-white">
          <h3 class="font-aktiv text-[18px] md:text-[20px] font-semibold mb-3 tracking-[0.9px]">The Harsh Truth:</h3>
          <p id="harsh-truth" class="font-montserrat text-[15px] md:text-[16px] leading-[26px] tracking-[1.5px] font-light mb-4">
            <!-- Truth inserted by JS -->
          </p>
          <p class="font-montserrat text-[16px] md:text-[18px] font-medium tracking-[0.8px]">
            Every 10 points you improve = approximately 15-25% increase in customer lifetime value.
          </p>
        </div>
      </div>

      <!-- Email Capture -->
      <div id="email-capture" class="animate-on-scroll fade-in-up bg-kd-cream rounded-[21px] p-8 md:p-10 text-center" style="box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
        <!-- Initial state: Show button -->
        <div id="email-prompt">
          <p class="font-montserrat text-kd-navy text-[16px] md:text-[18px] leading-[26px] tracking-[1.6px] mb-6">
            Would you like to get your results by email with recommendations?
          </p>
          <button
            id="show-email-form-btn"
            class="btn-navy py-3.5 px-8 rounded-full text-base font-montserrat font-medium tracking-wider"
            style="box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);"
          >
            Yes, Send My Results
          </button>
        </div>

        <!-- Email form (hidden initially) -->
        <form id="results-form" class="hidden max-w-sm mx-auto">
          <p class="font-montserrat text-kd-grey text-[15px] leading-[24px] tracking-[1.4px] mb-4">
            Enter your email to receive your personalized results and recommendations.
          </p>
          <div class="flex gap-3">
            <input
              type="email"
              id="result-email"
              name="email"
              placeholder="Enter your email"
              required
              class="flex-1 px-5 py-3.5 rounded-lg border border-kd-gold bg-white focus:outline-none focus:border-kd-gold text-base font-montserrat font-light text-kd-navy placeholder:text-gray-400"
            />
            <button
              type="submit"
              id="result-submit-btn"
              class="btn-navy px-6 py-3.5 rounded-lg text-base font-montserrat font-medium tracking-wider whitespace-nowrap"
              style="box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);"
            >
              <span id="result-submit-text">Send</span>
            </button>
          </div>
        </form>

        <!-- Success message (hidden by default) -->
        <p id="email-success" class="hidden text-kd-gold text-center text-[16px] font-montserrat font-semibold tracking-wide pt-4">
          âœ“ Check your email for your personalized results!
        </p>
      </div>
    </div>
  </section>

  <!-- ========================================
       CTA / CONSULTATION SECTION
       ======================================== -->
  <ConsultationCTA />
</Layout>

<script>
  // ========================================
  // STATE
  // ========================================
  const scores = {
    emailFlow: null,
    segmentation: null,
    personalization: null,
    attribution: null,
    postPurchase: null,
    winback: null,
    loyalty: null,
    testing: null,
    sms: null,
    ai: null
  };

  // ========================================
  // CATEGORIES DATA
  // ========================================
  const categories = [
    {
      id: 'emailFlow',
      title: '1. Email Flow Architecture',
      options: [
        { value: 0, label: 'No automated flows or only a basic welcome series' },
        { value: 1.5, label: 'Welcome + 1-2 other flows (cart/browse abandonment)' },
        { value: 3, label: '5-7 standard flows running' },
        { value: 4, label: '8-10 flows with basic segmentation' },
        { value: 5, label: '10+ flows with advanced behavioral triggers and dynamic content' }
      ]
    },
    {
      id: 'segmentation',
      title: '2. Customer Segmentation',
      options: [
        { value: 0, label: 'Sending the same message to everyone' },
        { value: 1.5, label: 'Basic segments (buyers vs non-buyers)' },
        { value: 3, label: '3-5 segments based on purchase behavior' },
        { value: 4, label: '6-10 segments including RFM (Recency, Frequency, Monetary)' },
        { value: 5, label: 'Dynamic behavioral segments with predictive modeling' }
      ]
    },
    {
      id: 'personalization',
      title: '3. Personalization Level',
      options: [
        { value: 0, label: 'Generic "Hi there" emails' },
        { value: 1.5, label: 'First name personalization only' },
        { value: 3, label: 'Product recommendations based on past purchases' },
        { value: 4, label: 'Dynamic content blocks based on customer data' },
        { value: 5, label: 'AI-driven 1:1 personalization at scale with predicted next purchase' }
      ]
    },
    {
      id: 'attribution',
      title: '4. Data & Attribution',
      options: [
        { value: 0, label: 'No tracking beyond open/click rates' },
        { value: 1.5, label: 'Basic Klaviyo dashboard monitoring' },
        { value: 3, label: 'Revenue attribution by flow' },
        { value: 4, label: 'Customer lifetime value tracking and cohort analysis' },
        { value: 5, label: 'Multi-touch attribution with predictive LTV modeling' }
      ]
    },
    {
      id: 'postPurchase',
      title: '5. Post-Purchase Strategy',
      options: [
        { value: 0, label: 'Maybe a thank you email' },
        { value: 1.5, label: 'Order confirmation + shipping updates only' },
        { value: 3, label: 'Post-purchase series with review request' },
        { value: 4, label: 'Segmented cross-sell/upsell based on first purchase' },
        { value: 5, label: 'Lifecycle campaigns that adapt to customer journey stage and predict replenishment' }
      ]
    },
    {
      id: 'winback',
      title: '6. Winback & Re-engagement',
      options: [
        { value: 0, label: 'No winback strategy' },
        { value: 1.5, label: 'Single "we miss you" email' },
        { value: 3, label: 'Basic winback series (30-60-90 days)' },
        { value: 4, label: 'Multi-stage winback with escalating incentives' },
        { value: 5, label: 'Predictive churn prevention with AI-powered timing and messaging' }
      ]
    },
    {
      id: 'loyalty',
      title: '7. VIP & Loyalty Program',
      options: [
        { value: 0, label: 'No loyalty strategy' },
        { value: 1.5, label: 'Generic "thanks for being a customer" emails' },
        { value: 3, label: 'Basic tiered program with points' },
        { value: 4, label: 'VIP segments with exclusive perks and early access' },
        { value: 5, label: 'Sophisticated loyalty ecosystem with gamification and community' }
      ]
    },
    {
      id: 'testing',
      title: '8. Testing & Optimization',
      options: [
        { value: 0, label: 'Set it and forget it' },
        { value: 1.5, label: 'Occasional manual tweaks' },
        { value: 3, label: 'Monthly review of flow performance' },
        { value: 4, label: 'Regular A/B testing of subject lines and content' },
        { value: 5, label: 'Continuous optimization with multivariate testing and AI-assisted insights' }
      ]
    },
    {
      id: 'sms',
      title: '9. SMS Integration',
      options: [
        { value: 0, label: 'Email only' },
        { value: 1.5, label: 'Basic SMS for shipping updates' },
        { value: 3, label: 'SMS for key flows (cart abandonment, back-in-stock)' },
        { value: 4, label: 'Coordinated email + SMS strategy' },
        { value: 5, label: 'Omnichannel orchestration with intelligent channel preference' }
      ]
    },
    {
      id: 'ai',
      title: '10. AI & Automation Sophistication',
      options: [
        { value: 0, label: 'Fully manual email creation' },
        { value: 1.5, label: "Using Klaviyo's basic automation" },
        { value: 3, label: 'Template-based automation with some customization' },
        { value: 4, label: 'Using AI for subject line optimization or send time' },
        { value: 5, label: 'AI-powered content generation, predictive analytics, and behavioral pattern recognition' }
      ]
    }
  ];

  // ========================================
  // MATURITY LEVELS (KDP Brand Colors)
  // ========================================
  function getMaturityLevel(score) {
    if (score <= 15) return {
      level: 'Foundation Stage',
      emoji: 'ðŸ—ï¸',
      bgColor: 'bg-kd-cream',
      borderColor: 'border-kd-grey/30',
      textColor: 'text-kd-navy',
      icon: `<svg class="w-8 h-8 text-kd-grey" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`,
      message: "You're leaving 40-60% of potential revenue on the table.",
      details: [
        "You're likely breaking even (or losing money) on first purchases",
        "Customer acquisition is bleeding your budget",
        "Your email is an afterthought, not a revenue driver"
      ],
      nextStep: "Build the core 7 flows (Welcome, Browse/Cart Abandonment, Post-Purchase, Winback, VIP). This alone can unlock 15-30% revenue lift.",
      harshTruth: "If you're under 25 points and doing $2M+ in revenue: You built your business on acquisition. That worked to get here. It won't work to get to $10M."
    };
    if (score <= 30) return {
      level: 'Growth Stage',
      emoji: 'ðŸ“ˆ',
      bgColor: 'bg-kd-cream',
      borderColor: 'border-kd-gold/40',
      textColor: 'text-kd-navy',
      icon: `<svg class="w-8 h-8 text-kd-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>`,
      message: "You have the basics, but you're still doing things manually that should be automated.",
      details: [
        "You're capturing some repeat revenue, but inconsistently",
        "Your segmentation is too broad",
        "You're guessing instead of using data"
      ],
      nextStep: "Implement behavioral segmentation and advanced attribution. Start using AI to identify patterns you're missing manually.",
      harshTruth: "At this level, you're leaving 25-40% of potential repeat revenue uncaptured. Your competitors who invest in retention will outpace you."
    };
    if (score <= 40) return {
      level: 'Scaling Stage',
      emoji: 'ðŸš€',
      bgColor: 'bg-kd-cream',
      borderColor: 'border-kd-gold/60',
      textColor: 'text-kd-navy',
      icon: `<svg class="w-8 h-8 text-kd-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>`,
      message: "You're doing well, but there's a 20-30% efficiency gap between where you are and where you could be.",
      details: [
        "Your retention machine is running",
        "You're making data-driven decisions",
        "But you're still leaving optimization opportunities on the table"
      ],
      nextStep: "Layer in AI-powered predictive analytics, advanced personalization, and omnichannel orchestration. This is where the real leverage happens.",
      harshTruth: "You're in the top 30% of e-commerce brands for retention. The gap to the top 5% is where the compound growth happens."
    };
    return {
      level: 'Elite Stage',
      emoji: 'ðŸ‘‘',
      bgColor: 'bg-kd-cream',
      borderColor: 'border-kd-gold',
      textColor: 'text-kd-gold',
      icon: `<svg class="w-8 h-8 text-kd-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>`,
      message: "You're in the top 5% of eCommerce brands.",
      details: [
        "Your retention strategy is sophisticated",
        "You're using AI and automation at scale",
        "Your LTV is 2-3x industry average"
      ],
      nextStep: "Focus on incremental improvements (1-2% gains compound quickly at this level). Consider thought leadership and consulting opportunities.",
      harshTruth: "At this level, your biggest risk is complacency. The best keep innovatingâ€”stay ahead of AI developments and emerging channels."
    };
  }

  // ========================================
  // FUNCTIONS
  // ========================================
  function calculateTotalScore() {
    return Object.values(scores).reduce((sum, score) => sum + (score || 0), 0);
  }

  function isComplete() {
    return Object.values(scores).every(score => score !== null);
  }

  function updateUI() {
    const totalScore = calculateTotalScore();
    const percentage = Math.round((totalScore / 50) * 100);

    // Update score display
    document.getElementById('current-score').textContent = totalScore.toFixed(1);
    document.getElementById('percentage-value').textContent = percentage;
    document.getElementById('progress-bar').style.width = `${percentage}%`;

    // Update completion status
    const answeredCount = Object.values(scores).filter(s => s !== null).length;
    const statusEl = document.getElementById('completion-status');
    if (isComplete()) {
      statusEl.textContent = 'âœ“ Assessment complete! See your results below.';
      statusEl.classList.add('text-kd-gold', 'font-medium');
      showResults();
    } else {
      statusEl.textContent = `${answeredCount}/10 questions answered`;
      statusEl.classList.remove('text-kd-gold', 'font-medium');
    }
  }

  function showResults() {
    const totalScore = calculateTotalScore();
    const maturity = getMaturityLevel(totalScore);

    // Show results section
    const resultsSection = document.getElementById('results-section');
    resultsSection.classList.remove('hidden');

    // Update results card styling
    const resultsCard = document.getElementById('results-card');
    resultsCard.className = `animate-on-scroll fade-in-up rounded-[21px] p-8 md:p-10 mb-8 border-2 ${maturity.bgColor} ${maturity.borderColor}`;

    // Update icon
    document.getElementById('results-icon').innerHTML = maturity.icon;

    // Update level and message
    document.getElementById('results-level').innerHTML = `${maturity.level} ${maturity.emoji}`;
    document.getElementById('results-level').className = `font-aktiv text-[24px] md:text-[32px] font-bold leading-tight tracking-[1.2px] mb-2 ${maturity.textColor}`;
    document.getElementById('results-message').textContent = maturity.message;

    // Update details
    const detailsEl = document.getElementById('results-details');
    detailsEl.innerHTML = maturity.details.map(detail => `
      <li class="flex items-start text-black font-montserrat text-[15px] leading-[24px] tracking-[1.5px] font-light">
        <span class="text-kd-gold mr-3 mt-1">â€¢</span>
        <span>${detail}</span>
      </li>
    `).join('');

    // Update next step
    document.getElementById('results-nextstep').textContent = maturity.nextStep;

    // Update harsh truth
    document.getElementById('harsh-truth').textContent = maturity.harshTruth;

    // Scroll to results
    setTimeout(() => {
      resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);

    // Trigger animation
    resultsSection.querySelectorAll('.animate-on-scroll').forEach(el => {
      el.classList.add('is-visible');
    });
  }

  function handleScoreChange(categoryId, value) {
    scores[categoryId] = value;
    updateUI();

    // Update visual state of options
    const container = document.querySelector(`[data-category="${categoryId}"]`);
    container.querySelectorAll('.option-label').forEach(label => {
      const input = label.querySelector('input');
      if (input.checked) {
        label.classList.remove('border-kd-cream', 'hover:border-kd-gold/50');
        label.classList.add('border-kd-gold', 'bg-kd-cream');
      } else {
        label.classList.remove('border-kd-gold', 'bg-kd-cream');
        label.classList.add('border-kd-cream', 'hover:border-kd-gold/50');
      }
    });
  }

  function renderQuestions() {
    const container = document.getElementById('questions-container');
    container.innerHTML = categories.map((category, catIndex) => `
      <div class="animate-on-scroll fade-in-up delay-${Math.min(catIndex * 100, 500)} bg-white rounded-[21px] p-6 md:p-8 border border-kd-cream" style="box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);" data-category="${category.id}">
        <h3 class="font-aktiv text-kd-navy text-[18px] md:text-[20px] font-semibold mb-6 tracking-[0.9px]">${category.title}</h3>
        <div class="space-y-3">
          ${category.options.map((option, optIndex) => `
            <label class="option-label flex items-start p-4 rounded-lg border-2 border-kd-cream cursor-pointer transition-all hover:border-kd-gold/50">
              <input
                type="radio"
                name="${category.id}"
                value="${option.value}"
                class="mt-1 mr-3 accent-kd-gold"
                onchange="handleScoreChange('${category.id}', ${option.value})"
              />
              <span class="font-montserrat text-black text-[14px] md:text-[15px] leading-[22px] tracking-[1.4px] font-light">${option.label}</span>
            </label>
          `).join('')}
        </div>
      </div>
    `).join('');

    // Re-observe animations
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1 });

    container.querySelectorAll('.animate-on-scroll').forEach(el => {
      observer.observe(el);
    });
  }

  // ========================================
  // EMAIL FORM HANDLER
  // ========================================
  // NOTE: This Klaviyo integration is a PLACEHOLDER.
  // The list ID (W3XhAb) and form logic may need to be updated
  // once a dedicated Klaviyo form/list is created for the calculator.
  // ========================================
  document.getElementById('results-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = (document.getElementById('result-email') as HTMLInputElement).value;
    const submitBtn = document.getElementById('result-submit-btn') as HTMLButtonElement;
    const submitText = document.getElementById('result-submit-text') as HTMLSpanElement;
    const successMsg = document.getElementById('email-success') as HTMLParagraphElement;
    const form = document.getElementById('results-form') as HTMLFormElement;

    const totalScore = calculateTotalScore();
    const maturity = getMaturityLevel(totalScore);

    submitBtn.disabled = true;
    submitText.textContent = '...';

    try {
      var companyId = 'SqUgaK';
      var listId = 'W3XhAb';
      var apiHeaders = {
        'Content-Type': 'application/json',
        'revision': '2024-10-15',
      };

      // Step 1: Create/update profile with calculator results
      await fetch('https://a.klaviyo.com/client/profiles/?company_id=' + companyId, {
        method: 'POST',
        headers: apiHeaders,
        body: JSON.stringify({
          data: {
            type: 'profile',
            attributes: {
              email: email,
              properties: {
                calculator_score: totalScore,
                maturity_level: maturity.level,
                source: 'retention_calculator',
                completed_date: new Date().toISOString(),
              },
            },
          },
        }),
      });

      // Step 2: Subscribe to list
      await fetch('https://a.klaviyo.com/client/subscriptions/?company_id=' + companyId, {
        method: 'POST',
        headers: apiHeaders,
        body: JSON.stringify({
          data: {
            type: 'subscription',
            attributes: {
              custom_source: 'Website - Retention Calculator',
              profile: {
                data: {
                  type: 'profile',
                  attributes: {
                    email: email,
                  },
                },
              },
            },
            relationships: {
              list: {
                data: {
                  type: 'list',
                  id: listId,
                },
              },
            },
          },
        }),
      });

      // Show success
      form.classList.add('hidden');
      successMsg.classList.remove('hidden');

    } catch (error) {
      submitText.textContent = 'Error. Try again.';
      submitBtn.disabled = false;
      setTimeout(() => {
        submitText.textContent = 'Send';
      }, 3000);
    }
  });

  // ========================================
  // SHOW EMAIL FORM HANDLER
  // ========================================
  document.getElementById('show-email-form-btn')?.addEventListener('click', () => {
    const prompt = document.getElementById('email-prompt');
    const form = document.getElementById('results-form');
    const emailInput = document.getElementById('result-email') as HTMLInputElement;

    prompt?.classList.add('hidden');
    form?.classList.remove('hidden');
    emailInput?.focus();
  });

  // ========================================
  // INITIALIZE
  // ========================================
  // Make handleScoreChange available globally
  (window as any).handleScoreChange = handleScoreChange;

  // Render questions on load
  renderQuestions();
</script>
